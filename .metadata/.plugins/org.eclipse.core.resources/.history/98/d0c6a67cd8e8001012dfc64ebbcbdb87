package com.capstone.coursemanagement.service;

import com.capstone.coursemanagement.dto.CourseModuleRequestDTO;
import com.capstone.coursemanagement.dto.CourseModuleResponseDTO;
import com.capstone.coursemanagement.entity.CourseModule;
import com.capstone.coursemanagement.repository.CourseModuleRepository;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
public class CourseModuleService {

    private final CourseModuleRepository repository;

    public CourseModuleService(CourseModuleRepository repository) {
        this.repository = repository;
    }

    public CourseModuleResponseDTO createModule(CourseModuleRequestDTO dto) {
        CourseModule module = new CourseModule();
        module.setCourseId(dto.getCourseId());
        module.setModuleOrder(dto.getModuleOrder());
        module.setTitle(dto.getTitle());
        module.setVideoUrl(dto.getVideoUrl());
        module.setDurationMinutes(dto.getDurationMinutes());

        return mapToResponse(repository.save(module));
    }

    public List<CourseModuleResponseDTO> getModulesByCourse(UUID courseId) {
    	System.out.println(courseId);
    	System.out.println(repository.findByCourseIdOrderByModuleOrder(courseId));
        return repository.findByCourseIdOrderByModuleOrder(courseId)
                .stream()
                .map(this::mapToResponse)
                .collect(Collectors.toList());
    }

    public CourseModuleResponseDTO getModuleById(UUID moduleId) {
        CourseModule module = repository.findById(moduleId)
                .orElseThrow(() -> new RuntimeException("Module not found"));
        return mapToResponse(module);
    }

    public CourseModuleResponseDTO updateModule(UUID moduleId, CourseModuleRequestDTO dto) {
        CourseModule module = repository.findById(moduleId)
                .orElseThrow(() -> new RuntimeException("Module not found"));

        module.setTitle(dto.getTitle());
        module.setModuleOrder(dto.getModuleOrder());
        module.setVideoUrl(dto.getVideoUrl());
        module.setDurationMinutes(dto.getDurationMinutes());

        return mapToResponse(repository.save(module));
    }

    public void deleteModule(UUID moduleId) {
        repository.deleteById(moduleId);
    }

    private CourseModuleResponseDTO mapToResponse(CourseModule module) {
        CourseModuleResponseDTO dto = new CourseModuleResponseDTO();
        dto.setId(module.getId());
        dto.setCourseId(module.getCourseId());
        dto.setModuleOrder(module.getModuleOrder());
        dto.setTitle(module.getTitle());
        dto.setVideoUrl(module.getVideoUrl());
        dto.setDurationMinutes(module.getDurationMinutes());
        dto.setActive(module.getActive());
        return dto;
    }
}
